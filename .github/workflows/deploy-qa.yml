name: Deploy ORC App to VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ðŸ” BÆ¯á»šC 1: Debug thÃ´ng tin trÆ°á»›c khi SSH
      - name: Preflight debug SSH config
        run: |
          echo "ðŸ” Preflight check before SSH..."

          echo "ðŸ‘‰ Host from secrets: ${{ secrets.VPS_HOST }}"
          echo "ðŸ‘‰ Username from secrets: ${{ secrets.VPS_USER }}"

          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "âŒ VPS_SSH_KEY is EMPTY. Check your repository secrets!"
            exit 1
          else
            echo "âœ… VPS_SSH_KEY is set (ná»™i dung sáº½ Ä‘Æ°á»£c GitHub tá»± mask)."
            echo "ðŸ”¢ Approx key length (chars): $(echo "${{ secrets.VPS_SSH_KEY }}" | wc -c)"
          fi

          echo "âœ… Preflight done. If you tháº¥y host/username Ä‘Ãºng, mÃ¬nh qua bÆ°á»›c SSH."
        shell: bash

      # ðŸš€ BÆ¯á»šC 2: SSH vÃ  deploy
      - name: Deploy ORC to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 15m
          debug: true          # Báº­t debug cá»§a ssh-action
          script_stop: true    # Náº¿u script fail thÃ¬ dá»«ng luÃ´n
          script: |
            set -euo pipefail
            echo "ðŸš€ Deploying ORC app to VPS..."
            cd ~/QAProject

            echo "::group::ðŸ“ Check QAProject folder"
            pwd
            ls -la
            echo "::endgroup::"

            echo "::group::ðŸ“œ Check deployQA.sh"
            if [ ! -f "./deployQA.sh" ]; then
              echo "âŒ KhÃ´ng tÃ¬m tháº¥y file deployQA.sh trong ~/QAProject"
              exit 1
            fi
            ls -la ./deployQA.sh
            chmod +x ./deployQA.sh || { echo "âŒ chmod failed"; exit 1; }
            dos2unix ./deployQA.sh 2>/dev/null || true
            echo "::endgroup::"

            echo "::group::ðŸš€ Run deployQA.sh with bash -x"
            bash -x ./deployQA.sh
            echo "::endgroup::"

            echo "âœ… Deployment completed successfully!"
